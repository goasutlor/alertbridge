<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>alertbridge-lite</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="hero-bg"></div>
    <main class="container">
      <header class="header">
        <div class="header-brand">
          <div>
            <h1>alertbridge-lite</h1>
            <p class="tagline">Stateless webhook relay & transformer for OCP & Confluent</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="lang-toggle">
            <button type="button" id="langEn" class="lang-btn" aria-pressed="true">EN</button>
            <button type="button" id="langTh" class="lang-btn" aria-pressed="false">TH</button>
          </div>
          <div id="portalStatus" class="portal-status" aria-live="polite">
            <span id="portalStatusDot" class="portal-status-dot"></span>
            <span id="portalStatusText">Checking…</span>
          </div>
          <div id="targetFwdStatus" class="portal-status target-fwd-status" aria-live="polite" style="display:none;">
            <span id="targetFwdStatusDot" class="portal-status-dot"></span>
            <span id="targetFwdStatusText" data-i18n="targetFwdChecking">Target Fwd: Checking…</span>
          </div>
        </div>
      </header>

      <section class="dashboard">
        <div class="dashboard-hero card">
          <h2 class="card-title">Realtime metrics</h2>
          <p class="card-subtitle">Requests per second · last 90 seconds</p>
          <div class="heartbeat-wrap">
            <canvas id="heartbeatChart" class="heartbeat-chart"></canvas>
            <div id="heartbeatLabel" class="heartbeat-label">0 req/s</div>
          </div>
        </div>
        <div class="dashboard-stats card">
          <h2 class="card-title">Request count</h2>
          <div id="statsPanel" class="stats-panel stats-grid">
            <div class="stat-card">
              <span class="stat-label">Total</span>
              <strong id="statsTotal" class="stat-value">0</strong>
              <span class="stat-unit">requests</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">By source</span>
              <span id="statsBySource" class="stat-inline stat-source">-</span>
            </div>
            <div class="stat-card">
              <span class="stat-label">Forward</span>
              <span class="stat-inline">success <strong id="statsForwardOk">0</strong> · failed <strong id="statsForwardFail">0</strong></span>
            </div>
          </div>
          <span id="statsStatus" class="status"></span>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title" data-i18n="liveEvents">Live Events (Incoming Webhooks)</h2>
        <p class="card-subtitle" data-i18n="liveEventsSub">Last 20 webhooks · refreshes every 1.5s · Use these for Field Mapper</p>
        <div id="liveRequestsContainer" class="live-requests">
          <table class="live-table">
            <thead>
              <tr>
                <th>Time (UTC)</th>
                <th>Source</th>
                <th>Route</th>
                <th>Alert</th>
                <th>Status</th>
                <th>Forwarded</th>
                <th>Request ID</th>
              </tr>
            </thead>
            <tbody id="liveRequestsBody"></tbody>
          </table>
          <p id="liveRequestsEmpty" class="live-empty"><span data-i18n="liveEmpty">No webhooks yet. POST to</span> <code>/webhook/ocp</code> <code>/webhook/confluent</code> <span data-i18n="orSource">or other source</span></p>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title" data-i18n="failedEvents">Failed Events (Forward did not succeed)</h2>
        <p class="card-subtitle" data-i18n="failedEventsSub">Display 20 · up to 200 stored (search all) · in-memory only (lost on restart)</p>
        <div class="failed-events-toolbar">
          <input type="text" id="failedEventsSearch" class="input-inline" placeholder="Search: source, route, request_id..." data-i18n-placeholder="failedSearchPlaceholder" />
        </div>
        <div id="failedEventsContainer" class="live-requests">
          <table class="live-table">
            <thead>
              <tr>
                <th>Time (UTC)</th>
                <th>Source</th>
                <th>Route</th>
                <th>Status</th>
                <th>Request ID</th>
                <th>Error</th>
              </tr>
            </thead>
            <tbody id="failedEventsBody"></tbody>
          </table>
          <p id="failedEventsEmpty" class="live-empty" data-i18n="failedEmpty">No failed events. Forward failures will appear here.</p>
        </div>
      </section>

      <section class="card card-routes">
        <h2 class="card-title" data-i18n="webhookEndpoints">Webhook Endpoints (Alert Receivers)</h2>
        <p class="card-subtitle" data-i18n="webhookSub">Routes available — Clients can POST to <code>/webhook/{source}</code></p>
        <div id="routesPanel" class="routes-panel">
          <ul id="routesList" class="routes-list"></ul>
          <div id="routesEmpty" class="routes-empty" style="display:none;">
            <p class="text-muted" data-i18n="noRoutes">No routes configured. Add routes in Config (YAML) below.</p>
          </div>
        </div>
        <div id="clientInfoPanel" class="client-info-panel" style="display:none;">
          <h3 class="client-info-title" data-i18n="clientInfo">Client Info (for sending alerts)</h3>
          <div id="clientInfoContent" class="client-info-content"></div>
        </div>
      </section>

      <section class="card card-api-keys">
        <h2 class="card-title">API Keys (incoming webhook auth)</h2>
        <p class="card-subtitle">Generate API keys for OCP/Confluent (or any client) to send alerts. Clients send <code>X-API-Key</code> or <code>Authorization: Bearer &lt;key&gt;</code>.</p>
        <div class="api-keys-toolbar">
          <input type="text" id="apiKeyNameInput" class="input-inline" placeholder="e.g. ocp-prod, confluent-staging" />
          <button id="genApiKeyBtn" class="btn btn-primary">Gen API Key</button>
          <span id="apiKeysStatus" class="status"></span>
        </div>
        <div id="apiKeyNewKeyBox" class="api-key-new-box" style="display:none;">
          <p class="api-key-copy-hint" data-i18n="copyNow">Copy now — this key is shown only once.</p>
          <div class="api-key-value-row">
            <code id="apiKeyNewKeyValue"></code>
            <button type="button" id="apiKeyCopyBtn" class="btn btn-secondary">Copy</button>
          </div>
        </div>
        <ul id="apiKeysList" class="api-keys-list"></ul>
      </section>

      <section class="card card-mapper">
        <h2 class="card-title">Field Mapper</h2>
        <p class="card-subtitle">Map alarm fields from source (left) to target (right). Save as pattern and apply to route.</p>
        <div class="mapper-two-modes">
          <p class="mapper-modes-desc" data-i18n="sourceModes"><strong>Source pattern options:</strong></p>
          <ul class="mapper-modes-list">
            <li data-i18n="fromLive"><strong>From live traffic</strong> — Select payload below, then Use as source fields</li>
            <li data-i18n="manual"><strong>Manual</strong> — Select template (OCP/Confluent) or Custom (paste example log)</li>
          </ul>
        </div>
        <div class="mapper-target-upload">
          <h3 class="mapper-col-title" data-i18n="targetTitle">Target (output) — from example log</h3>
          <p class="mapper-desc" data-i18n="targetDesc">Upload or paste one example log (JSON) of the format you want to send. Parsed into fields for mapping.</p>
          <div class="mapper-paste-row">
            <textarea id="mapperTargetExample" class="textarea mapper-paste-json" placeholder='Paste target example JSON e.g. {"severity":"P1","title":"...","message":"..."}'></textarea>
            <div class="mapper-paste-actions">
              <input type="file" id="mapperTargetFile" accept=".json,application/json" class="mapper-file-input" />
              <label for="mapperTargetFile" class="btn btn-secondary">Upload JSON</label>
              <button id="mapperParseTargetBtn" class="btn btn-primary">Parse as target pattern</button>
            </div>
          </div>
          <div id="mapperTargetPatternStatus" class="status"></div>
        </div>
        <div class="mapper-toolbar">
          <label for="mapperSourceType">Option 2 — Manual: Source (incoming log)</label>
          <select id="mapperSourceType" class="select mapper-select"></select>
          <div id="mapperSourceCustomWrap" class="mapper-custom-paste" style="display:none;">
            <textarea id="mapperSourceExample" class="textarea mapper-paste-json-small" placeholder="Paste example incoming log JSON"></textarea>
            <button id="mapperParseSourceBtn" class="btn btn-secondary">Use as source fields</button>
          </div>
          <label for="mapperPatternName" class="mapper-name-label">Pattern name</label>
          <input type="text" id="mapperPatternName" class="input-inline" placeholder="e.g. OCP to standard" />
          <select id="mapperLoadPatternSelect" class="select"><option value="">— Select pattern —</option></select>
          <button id="mapperLoadPatternBtn" class="btn btn-secondary">Load</button>
        </div>
        <div id="mapperSourceDescription" class="mapper-desc"></div>
        <div id="recentPayloadsSection" class="recent-payloads-section">
          <h3 class="mapper-col-title" data-i18n="mode1">Option 1 — From live traffic (recommended)</h3>
          <p class="mapper-desc" data-i18n="mode1Steps"><strong>Steps:</strong> 1) Check Live Events 2) Select payload 3) Use as source fields 4) Map to Target 5) Save as pattern</p>
          <p class="mapper-desc tip-desc" style="margin-top: 8px; color: var(--accent);"><span data-i18n="tip">Tip: If no Live Events, send test webhook to</span> <code>/webhook/{source}</code> <span data-i18n="first">first</span></p>
          <ul id="recentPayloadsList" class="recent-payloads-list"></ul>
          <div id="recentPayloadsStatus" class="status"></div>
        </div>
        <div class="mapper-columns">
          <div class="mapper-col mapper-col-source">
            <h3 class="mapper-col-title">Source fields (incoming webhook)</h3>
            <ul id="mapperSourceFields" class="mapper-field-list"></ul>
          </div>
          <div class="mapper-col mapper-col-target">
            <h3 class="mapper-col-title">Target fields (forward output)</h3>
            <table id="mapperMappingTable" class="mapper-table">
              <thead>
                <tr><th>Target</th><th>Map from source</th><th>Or static value</th></tr>
              </thead>
              <tbody id="mapperMappingBody"></tbody>
            </table>
          </div>
        </div>
        <div class="mapper-actions actions">
          <button id="mapperSavePatternBtn" class="btn btn-primary">Save as pattern</button>
          <label for="mapperApplyRoute">Apply to route</label>
          <select id="mapperApplyRoute" class="select"></select>
          <button id="mapperApplyBtn" class="btn btn-primary">Apply to route</button>
          <span id="mapperStatus" class="status"></span>
        </div>
        <div id="savedPatternsSection" class="saved-patterns">
          <h3 class="mapper-col-title">Saved patterns</h3>
          <ul id="savedPatternsList" class="saved-patterns-list"></ul>
        </div>
      </section>

      <section class="card card-target-urls">
        <h2 class="card-title" data-i18n="targetUrls">Target URLs & API Keys (Forward Out)</h2>
        <p class="card-subtitle" data-i18n="targetUrlsSub">Set URL and API Key for forwarding alerts to target.</p>
        <div id="targetUrlsPanel" class="target-urls-panel"></div>
        <div id="targetUrlsEffective" class="target-urls-effective"></div>
        <div class="actions">
          <button id="saveTargetUrlsBtn" class="btn btn-primary" data-i18n="saveTargetUrls">Save target URLs & API Keys</button>
          <span id="targetUrlsStatus" class="status"></span>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title">Config (YAML)</h2>
        <textarea id="configTextarea" class="textarea" placeholder="Paste or edit rules YAML..."></textarea>
        <div class="actions">
          <button id="saveBtn" class="btn btn-primary">Save</button>
          <button id="reloadBtn" class="btn btn-secondary">Reload</button>
          <span id="configStatus" class="status"></span>
        </div>
      </section>

      <section class="card">
        <h2 class="card-title">Test / Preview</h2>
        <div class="form-row">
          <label for="sourceSelect">Source</label>
          <select id="sourceSelect" class="select"></select>
        </div>
        <textarea id="sampleTextarea" class="textarea" placeholder="Paste sample JSON payload here"></textarea>
        <div class="actions">
          <button id="previewBtn" class="btn btn-primary">Preview Transform</button>
          <span id="previewStatus" class="status"></span>
        </div>
        <pre id="previewOutput" class="output"></pre>
      </section>
    </main>

    <script src="/static/i18n.js"></script>
    <script src="/static/app.js?v=16"></script>
  </body>
</html>
