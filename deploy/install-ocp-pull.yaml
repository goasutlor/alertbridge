# alertbridge-lite - OCP Deployment via Pre-built Image (v1.1.0)
#
# Use this when OCP BuildConfig fails (e.g. proxy blocks pip). Image is built by GitHub Actions
# and pushed to ghcr.io on every push to main.
#
# Deploy steps:
# 1. Image is at ghcr.io/goasutlor/alertbridge-lite:latest (auto-built on push to main)
#
# 2. Edit Secret (TARGET_URL_*, API keys, BASIC_AUTH_*). Default UI login: admin/change-me
#
# 3. If 403 Forbidden when pulling: create GHCR pull secret (uncomment imagePullSecrets below):
#    oc create secret docker-registry ghcr-pull-secret \
#      --docker-server=ghcr.io --docker-username=goasutlor --docker-password=YOUR_GITHUB_PAT \
#      -n alertbridge
#
# 4. oc apply -f deploy/install-ocp-pull.yaml
# 5. oc get route -n alertbridge   # get webhook URL
# 6. Test: curl -k https://<route>/healthz

---
apiVersion: v1
kind: Namespace
metadata:
  name: alertbridge
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: alertbridge-lite
  namespace: alertbridge
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: alertbridge-configmap-editor
  namespace: alertbridge
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["alertbridge-rules"]
    verbs: ["get", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: alertbridge-configmap-editor
  namespace: alertbridge
subjects:
  - kind: ServiceAccount
    name: alertbridge-lite
    namespace: alertbridge
roleRef:
  kind: Role
  name: alertbridge-configmap-editor
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertbridge-rules
  namespace: alertbridge
data:
  rules.yaml: |
    version: 1
    defaults:
      target_timeout_connect_sec: 2
      target_timeout_read_sec: 5
    routes:
    - name: ocp-alertmanager
      match:
        source: ocp
      unroll_alerts: true
      target:
        url_env: TARGET_URL_OCP
        api_key_header: X-API-Key
        api_key_env: TARGET_API_KEY_OCP
      transform:
        include_fields: [alerts, commonAnnotations, commonLabels, groupLabels]
        output_template:
          type: flat
          fields:
            title: $.groupLabels.alertname
            message: $.commonAnnotations.summary
            status: $.alerts.0.status
    - name: confluent-alerts
      match:
        source: confluent
      target:
        url_env: TARGET_URL_CONFLUENT
        api_key_header: X-API-Key
        api_key_env: TARGET_API_KEY_CONFLUENT
      transform:
        include_fields: [alertId, description, severity]
        output_template:
          type: flat
          fields:
            alert_id: $.alertId
            message: $.description
            severity: $.severity
    auth:
      api_keys:
        required: false
        keys: []
---
apiVersion: v1
kind: Secret
metadata:
  name: alertbridge-secrets
  namespace: alertbridge
type: Opaque
stringData:
  TARGET_URL_OCP: "https://example.ocp.target/webhook"
  TARGET_API_KEY_OCP: "change-me"
  TARGET_URL_CONFLUENT: "https://example.confluent.target/webhook"
  TARGET_API_KEY_CONFLUENT: "change-me"
  # Basic Auth for UI (enabled by default). CHANGE password before production!
  BASIC_AUTH_USER: "admin"
  BASIC_AUTH_PASSWORD: "change-me"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertbridge-lite
  namespace: alertbridge
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertbridge-lite
  template:
    metadata:
      labels:
        app: alertbridge-lite
    spec:
      serviceAccountName: alertbridge-lite
      # Uncomment if package is private or cluster gets 403 when pulling from ghcr.io:
      # imagePullSecrets:
      #   - name: ghcr-pull-secret
      containers:
        - name: alertbridge-lite
          image: ghcr.io/goasutlor/alertbridge-lite:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
          env:
            - name: ALERTBRIDGE_CONFIGMAP_NAME
              value: "alertbridge-rules"
            - name: ALERTBRIDGE_CONFIG_WATCH_INTERVAL
              value: "30"
            - name: TARGET_URL_OCP
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: TARGET_URL_OCP
            - name: TARGET_API_KEY_OCP
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: TARGET_API_KEY_OCP
            - name: TARGET_URL_CONFLUENT
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: TARGET_URL_CONFLUENT
            - name: TARGET_API_KEY_CONFLUENT
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: TARGET_API_KEY_CONFLUENT
            - name: BASIC_AUTH_USER
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: BASIC_AUTH_USER
            - name: BASIC_AUTH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: alertbridge-secrets
                  key: BASIC_AUTH_PASSWORD
          volumeMounts:
            - name: rules
              mountPath: /etc/alertbridge/rules.yaml
              subPath: rules.yaml
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: rules
          configMap:
            name: alertbridge-rules
            items:
              - key: rules.yaml
                path: rules.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: alertbridge-lite
  namespace: alertbridge
spec:
  selector:
    app: alertbridge-lite
  ports:
    - name: http
      port: 80
      targetPort: 8080
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: alertbridge-lite
  namespace: alertbridge
spec:
  host: alertbridge-lite.apps.cwdc.esb-kafka-prod.intra.ais  # EDIT: match your cluster apps domain
  to:
    kind: Service
    name: alertbridge-lite
  port:
    targetPort: http
  tls:
    termination: edge
    insecureEdgeTerminationPolicy: None
